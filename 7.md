## 7 USER AUTHENTI

## 7.0 Create Account part One

#### [SchemaType.prototype.unique()](https://mongoosejs.com/docs/api.html#schematype_SchemaType-unique)

고유 인덱스를 선언함
제약 조건을 위반하면 Mongoose 유효성 검사 오류가 아니라 저장할 때 MongoDB에서 E11000 오류를 반환함.

`unique: true` :

- USER의 email 이나 username 은 딱 하나만 존재함
- 같은 email/usename을 가진 계정이 여러개면안됨

```js
import mongoose from "mongoose";

const userSchema = new mongoose.Schema({
  email: { type: String, required: true, unique: true },
  username: { type: String, required: true, unique: true },
  password: { type: String, required: true },
  name: { type: String, required: true },
  location: String,
});

const User = mongoose.model("User", userSchema);
export default User;
```

## 7.1 Create Account part Two

```js
// controller/userController
export const postJoin = async (req, res) => {
  const { username, email, password, name, location } = req.body;
  await User.create({
    username,
    email,
    password,
    name,
    location,
  });
  return res.redirect("/login");
};
```

postJoin 이후 terminal

```
$ monghsh
$ show dbs
$ use wetube
$ show collection
$ db.users.find()
```

## 7.2 Creating Account part Three

결정적 함수 (deterministic function)
같은 입력값에는 항상 같은 해시 결과값이 나옴

[비밀번호 털렸다고? 암호화. 해시함수. 5분 설명 영상](https://www.youtube.com/watch?v=67UwxR3ts2E)

`remove()` 명령어 실행이 안될 때
`db.users.remove()`는 deprecated되었기 때문에
`db.users.deleteMany({})`로 지우시면 됩니다.

[해시함수 테스트](https://emn178.github.io/online-tools/sha256.html)

#### bcrypt

- 암호를 해싱할 때 사용
- blowfish cipher 기반으로 만들어짐
- 여러 언어에서 사용가능

[bcrypt 설치](https://www.npmjs.com/package/bcrypt)
암호를 해시하는 데 도움이 되는 라이브러리입니다.
`npm i bcrypt`

```js
bcrypt.hash(유저 비밀번호 , db에 저장하기 전에 몇 번 해싱할건지, 해싱하고 나온 출력값: 콜백함수)
```

[`Schema.prototype.pre()`](https://mongoosejs.com/docs/api.html#schema_Schema-pre)

여기서의 this는 create 되는 user의 this를 가리킴
save 하기전에 입력한 비밀번호를 5번 해싱하고 저장

```js
userSchema.pre("save", async function () {
  this.password = await bcrypt.hash(this.password, 5);
});
```

## 7.3 Form Validation

## 7.4 Status Codes

## 7.5 Login part One

## 7.6 Login part Two

## 7.7 Sessions and Cookies part One

## 7.8 Sessions and Cookies part Two

## 7.9 Logged In User

## 7.10 Logged In User part Two

## 7.11 Recap

# 7.12 MongoStore

# 7.13 Uninitialized Sessions

# 7.14 Expiration and Secrets

# 7.15 Environment Variables

# 7.16 Github Login part One

# 7.17 Github Login part Two

# 7.18 Github Login part Three

# 7.19 Github Login part Four

# 7.20 Github Login part Five

# 7.21 Github Login part Six

# 7.22 Log Out

# 7.23 Recap
