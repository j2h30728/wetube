# 8 USER PROFILE

# 8.0 Edit Profile GET

# 8.1 Protector and Public Middlewares

### middlware 사용

로그인 유무에 따라서 페이지 경로 제한

```js
//middleware.js

//로그인 되어있을 경우 통과, 그렇지않을 경우 login 페이지로 리다이렉트
export const protectMiddleware = (req, res, next) => {
  if (req.session.loggedIn) {
    return next();
  } else {
    return res.redirect("/login");
  }
};

//로그인 되어있지 않을 경우 통과, 그렇지않을 경우 / 페이지로 리다이렉트
export const publickOnlyMiddleware = (req, res, next) => {
  if (!req.session.loggedIn) {
    return next();
  } else {
    return res.redirect("/");
  }
};
```

#### all

`.get().post()` 의 컨트롤러에 모두 미들웨어로 거침

```js
//rooteRouter.js
rootRouter
  .route("/join")
  .all(publickOnlyMiddleware)
  .get(getJoin)
  .post(postJoin);
rootRouter
  .route("/login")
  .all(publickOnlyMiddleware)
  .get(getLogin)
  .post(postLogin);

//userRouter.js
userRouter.route("/edit").all(protectMiddleware).get(getEdit).post(postEdit);
userRouter.get("/github/start", publickOnlyMiddleware, startGithubLogin);
userRouter.get("/github/finish", publickOnlyMiddleware, finishGithubLogin);
```

# 8.2 Edit Profile POST part One

[`Model.findByIdAndUpdate()`](https://mongoosejs.com/docs/api.html#model_Model.findByIdAndUpdate)

문서의 \_id 필드로 mongodb findAndModify 업데이트 명령을 실행함.
`findByIdAndUpdate(id, ...)`는 `findOneAndUpdate({ \_id: id }, ...)`와 동일

```js
// 사용 예시
Model.findByIdAndUpdate(id, { name: "jason bourne" }, options, callback);

// is sent as (+타입스크립트)
Model.findByIdAndUpdate(
  id,
  { $set: { name: "jason bourne" } },
  options,
  callback
);
```

# 8.3 Edit Profile POST part Two

#### option

`{new:true}` : 리턴값을 업데이트된 값을 넣어줌
기재하지 않는 디폴트 값은 업데이트 전의 오리지널 값을 리턴하마

```js
const updateUser = await User.findByIdAndUpdate(
  _id,
  {
    name,
    email,
    username,
    location,
  },
  { new: true } // 해당 옵션 값을 넣을경우, 리턴값이 업데이트된 값이 됨
);
req.session.user = updateUser;
```

# 8.4 Change Password part One

# 8.5 Change Password part Two

```js
export const getChangePassword = (req, res) => {
  if (req.session.socialOnly === true) {
    return res.redirect("/");
  }
  return res.render("users/change-password", { pageTitle: "Change Password" });
};
export const postChangePassword = async (req, res) => {
  const {
    session: {
      user: { _id },
    },
    body: { oldPassword, newPassword, newPasswordConfirm },
  } = req;
  const user = await User.findById({ _id });

  // await user.save()에서 데이터이스에서 데이터가 수정됨
  user.password = newPassword;
  user.location = "이거되나?";

  // 비밀번호를 다섯번 해싱하는 pre 함수 트리거시킴 userSchema.pre("save",..)
  // 해싱된 비밀번호를 함께 데이터베이스에 저장
  await user.save();

  // 해커들이 로직 파악 후, 302 redirect를 프록시로 통해서 막은후 이전 세션데이터를 활용할수 있음
  // 안전하게 session을 destroy 시킴
  req.session.destroy();

  //비밀번호 변경완료 된후, login 페이지로 redirect시킴
  return res.redirect("/login");
};
```

#### [bcrypt](https://www.npmjs.com/package/bcrypt)

// 비밀번호 비교

```js
const match = await bcrypt.compare(password, user.passwordHash);
```

#### [`Model.findByIdAndUpdate()`](https://mongoosejs.com/docs/api.html#model_Model.findByIdAndUpdate)

`findByIdAndUpdate`로는 `pre('save')`를 실행시키지 않기 때문에 비밀번호가 해시화되지 않고 DB에 저장되게 됨.
그래서 `save()`메서드를 통해 `pre('save')`를 실행시켜 비밀번호를 해시화한 후 DB에 저장될 수 있도록 해줌

#### [`Model.prototype.save()`](https://mongoosejs.com/docs/api.html#model_Model-save)

`findByIdAndUpdate`를 이용해서 Document업데이트 후 save하기
앞서 했던 것처럼 `findByIdAndUpdate`를 통해 Document를 업데이트 시키고 업데이트된 최신 Document를 받아서 save이 가능함
(자바스크립트로 진행한다면 $set은 사용하지 않아도 됨)

```js
const updatedUser = await User.findByIdAndUpdate(
  loggedInUser?._id,
  { $set: { password: newPassword } },
  { new: true }
);
await updatedUser?.save();
```

# 8.6 File Uploads part One

# 8.7 File Uploads part Two

# 8.8 Static Files and Recap

# 8.9 Video Upload

# 8.10 User Profile

# 8.11 Video Owner

# 8.12 Video Owner part Two

# 8.13 User's Videos

# 8.14 Bugfix

# 8.15 Conclusions
