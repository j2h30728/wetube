# 6 MONGODB AND MONGOOSE

## 6.0 Array Database part One

`req.params.id`

```js
export const see = (req, res) => {
  const { id } = req.params;
  const video = videos[id - 1];
  return res.render("watch", { pageTitle: `Watching ${video.title}` });
};
```

```pug
mixin video(info)
  div
    h4
      a(href=`videos/${info.id}`)= info.title
    ul
      li #{ info.rating }/5.
      li #{ info.comments } comments.
      li Posted #{ info.createdAt }.
      li #{ info.views } views.
```

## 6.1 Array Database part Two

#### absolute URL , relative URL

1. absolut URL :`/`ë¶€í„° ìž‘ì„±í•´ì„œ ì ˆëŒ€ê²½ë¡œ ë¶€í„° ì‹œìž‘
   `href='/videos/123/edit`
2. relative URL : í˜„ìž¬ì˜ url ê²½ë¡œì—ì„œ ì´ë™
   `href='edit'`

## 6.2 Edit Video part One

#### POST , GET

```js
//videoControllers.js
export const watch = (req, res) => {
  const { id } = req.params;
  const video = videos[id - 1];
  return res.render("watch", { pageTitle: `Watching ${video.title}`, video });
};
export const edit = (req, res) => {
  const { id } = req.params;
  const video = videos[id - 1];
  return res.render("edit", { pageTitle: "Edit", video });
};
```

```pug
//watch.pug
extends base.pug

block content
  h3 #{ video.views } #{ video.views === 1 ? "view" : "views" }
  a(href=`${video.id}/edit`) Edit Video &rarr;
```

form íƒœê·¸ì˜ ê¸°ë³¸ ê¸°ëŠ¥ì€ GET ìž„

```pug
//edit.pug
extends base.pug

block content
  h4 Change Title of video

  form(action="testing-change", methdo="GET")
    input(name="title", placeholder="Video Title", value=video.title, required)
    input(value="Save", type="Submit")
```

ìœ„ì˜ ì½”ë“œë¥¼ ê°€ì§„ formì—ì„œ ê°’ì„ ìž…ë ¥í›„ submití•˜ê²Œë˜ë©´
ì•„ëž˜ì˜ ë§í¬ë¡œ ì´ë™í•˜ë©° actioní”„ë¡œí¼í‹° ê°’ìœ¼ë¡œ getìš”ì²­ì„ ë³´ëƒ„
(`form(action="testing-change" method="GET")` ì™€ ë™ì¼í•¨)
: formì— ìžˆëŠ” ì •ë³´ê°€ url ë¡œ ë“¤ì–´ê°
`form(method="POST", action="/videos/otherurl")` : action ì„ ì‚¬ìš©í•´ ë‹¤ë¥¸ urlë¡œ post ìš”ì²­ ê°€ëŠ¥

```
http://localhost:4000/videos/2/testing-change?title=testInputValue
Cannot GET /videos/2/testing-change

```

POST ìš”ì²­ìœ¼ë¡œ ë³´ë‚´ëŠ” form

```pug
extends base.pug

block content
  h4 Change Title of video

  form(method="POST")
    input(name="title", placeholder="Video Title", value=video.title, required)
    input(value="Save", type="Submit")
```

```
http://localhost:4000/videos/2/edit
Cannot POST /videos/2/edit
```

edit post Router, Controller ì¶”ê°€

```js
//videoRouter.js
videoRouter.get("/:id(\\d+)/edit", getEdit);
videoRouter.post("/:id(\\d+)/edit", postEdit);

//videoController.js
export const getEdit = (req, res) => {
  const { id } = req.params;
  const video = videos[id - 1];
  return res.render("edit", { pageTitle: "Edit", video });
};
export const postEdit = (req, res) => {};
```

## 6.3 Edit Video part Two

#### [req.body](https://expressjs.com/ko/api.html#req.body)

`req.body`ì—ëŠ” `form`ì„ í†µí•´ `submit`ëœ ë°ì´í„°ì˜ í‚¤-ê°’ ìŒì„ í¬í•¨í•¨
ê¸°ë³¸ì ìœ¼ë¡œëŠ” `undefined`ì´ë©° **`express.json()`** ë˜ëŠ” **`express.urlencoded()`**ì™€ ê°™ì€ ë°”ë”” íŒŒì‹± ë¯¸ë“¤ì›¨ì–´ë¥¼ ì‚¬ìš©í•  ë•Œ ê°’ì„ ë°›ì•„ì˜´

```js
// ì• í”Œë¦¬ì¼€ì´ì…˜/json íŒŒì‹±
app.use(express.json());
// application/x-www-form-urlencodedíŒŒì‹± (formë°ì´í„° íŒŒì‹±)
// form ì„ ìš°ë¦¬ê°€ ì‚¬ìš©í•  ìˆ˜ìžˆëŠ” javascript objectí˜•ì‹ì„ í†µì—­í•´ì¤Œ
app.use(express.urlencoded({ extended: true }));
```

##### [`express.urlencoded([options])`](https://expressjs.com/ko/api.html#express.urlencoded)

Expressì— ë‚´ìž¥ëœ ë¯¸ë“¤ì›¨ì–´ ê¸°ëŠ¥
urlencoded íŽ˜ì´ë¡œë“œë¡œ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ì„ êµ¬ë¬¸ ë¶„ì„í•˜ê³  ë°”ë”” íŒŒì„œë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•¨

##### route

get,postë¥¼ ë”°ë¡œ ì“°ëŠ” ëŒ€ì‹ ì—, í•˜ë‚˜ì˜ ê²½ë¡œë§Œ í•„ìš”ë¡œ í•˜ëŠ” routeì‚¬ìš©
2ê°œ ì´ìƒì˜ methodë¥¼ ì‚¬ìš©í•  ë•Œ ì‚¬ìš©í•˜ëŠ”ê²ƒì´ ìš©ì´

```js
//ì´ì „
videoRouter.get("/:id(\\d+)/edit", getEdit);
videoRouter.post("/:id(\\d+)/edit", postEdit);

//ì´í›„
videoRouter.route("/:id(\\d+)/edit").get(getEdit).post(postEdit);
```

POST ìš”ì²­ì„ ì§„í–‰í•˜ê³  watch ë¼ìš°íŠ¸ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
POST : back endë¡œ ë°ì´í„°ë¥¼ ë³´ëƒ„

```js
export const postEdit = (req, res) => {
  const { id } = req.params; // í•´ë‹¹ id ê°’ì„ ê°€ì ¸ì˜´
  const title = req.body.title; // forn ì— ìž…ë ¥í•œ ê°’ì„ ê°€ì ¸ì˜´
  videos[id - 1].title = title; // form ì— ìž…ë ¥í•œ ê°’ìœ¼ë¡œ title ìˆ˜ì •
  return res.redirect(`/videos/${id}`); // ìˆ˜ì •í›„, í•´ë‹¹ idì˜ watch routeë¡œ ì´ë™
};
```

## 6.4 Recap

input ì—ì„œ name ì„ ë¹ ëœ¨ë¦¬ê³  post ìš”ì²­ ë³´ë‚´ë©´ req.bodyì—ì„œ ë°ì´í„°ë¥¼ ë³¼ ìˆ˜ ì—†ìŒ

## 6.5 More Practice part One

## 6.6 More Practice part Two

```pug
extends base.pug

block content
  form(method="POST")
    input(name="title", type="text", required, placeholder="Title")
    input(type="submit", value="Upload Video")
```

**`postUpload` Controller**
ë‘ ê²½ë¡œë¡œ ì´ë™

1. post requestë¡œ '/vidoes/upload/ë¡œ ê°
2. get requestë¡œ í™ˆíŽ˜ì´ì§€ì¸ '/' ê°

```js
export const postUpload = (req, res) => {
  // here we will add a video to the videos array.
  return res.redirect("/");
};
```

## 6.7 Introduction to MongoDB

[MongoDB ë‹¤ìš´ë¡œë“œ ì‚¬ì´íŠ¸](https://docs.mongodb.com/manual/installation)

[MongoDB ì„¤ì¹˜ (MacOSìš©)](https://docs.mongodb.com/manual/tutorial/install-mongodb-on-os-x/)
í„°ë¯¸ë„ì—ì„œ ì•„ëž˜ì™€ ê°™ì´ ìž…ë ¥í•˜ì‹œë©´ ë©ë‹ˆë‹¤.

1. xcode-select --install

2. brew tap mongodb/brew
   (Homebrew ì„¤ì¹˜ê°€ ì•ˆ ë˜ìžˆìœ¼ë©´ ì„¤ì¹˜ í•„ìš”)

3. brew install mongodb-community@5.0
   (ë²„ì „ì€ ì¶”í›„ì— ë‹¬ë¼ì§ˆ ìˆ˜ ìžˆìŠµë‹ˆë‹¤.)

[MongoDB Compass (MongoDB GUI)](https://www.mongodb.com/products/compass)

## 6.8 Connecting to Mongo

node.jsì—ì„œ mongoDBì™€ ìƒí˜¸ìž‘ìš©í•˜ê¸° ìœ„í•´ mongooseì‚¬ìš©í•˜ëŠ” ê²ƒ
(ìžë°”ìŠ¤íŠ¸ë¦½íŠ¸ ì½”ë“œë¥¼ mongooseê°€ mongoDBì—ê²Œ ì „ë‹¬í•´ì¤Œ)

`mongosh
show dbs`

### mongoose ì„¤ì¹˜

`npm i mongoose`

`mongoose.connect("mongodb://127.0.0.1:27017/**ë§Œë“¤ê³  ì‹¶ì€ ë°ì´í„°ë² ì´ìŠ¤ ì´ë¦„**")

mongoë¥¼ ì—°ê²°í•¨

```js
import "./db";
```

ë°ì´í„°ë°ì´ìŠ¤(ëª½ê³ )ì—°ê²° ì„¸íŒ…. ì„±ê³µí•  ê²½ìš°ì™€ ì‹¤íŒ¨í•œ ê²½ìš°.
`db.on('event', eventê°€ ì¼ì–´ë‚˜ë©´ ì‹¤í–‰ì‹œí‚¬ ì½œë°±í•¨ìˆ˜)`

```js
//db.js
import mongoose from "mongoose";

mongoose.set("strictQuery", false);
mongoose.connect("mongodb://127.0.0.1:27017/wetube", {
  useNewUrlParser: true,
  useUnifiedTopology: true,
});

const db = mongoose.connection;
const handleOpen = () => console.log("âœ… Connected to DB");
const handleError = error => console.log("âŒ DB Error", error);

db.on("error", handleError); // errorê°€ ë°œìƒí•  ë•Œ ë§ˆë‹¤ ì‹¤í–‰ë¨
db.once("open", handleOpen); // ì„œë²„ê°€ ì—°ê²°ë  ë•Œ ë”± í•œë²ˆ ì‹¤í–‰ë¨
```

---

macOS

`MongoDB shell version v5.0.0
connecting to: mongodb://127.0.0.1:27017/?compressors=disabled&gssapiServiceName=mongodb
Error: couldn't connect to server 127.0.0.1:27017, connection attempt failed: SocketException: Error connecting to 127.0.0.1:27017 :: caused by :: Connection refused :
connect@src/mongo/shell/mongo.js:372:17
@(connect):2:6
exception: connect failed
exiting with code 1
-----------------------------------`
ì´ë ‡ê²Œ ëœ¨ë©´
M1: `mongod --config /opt/homebrew/etc/mongod.conf --fork`

**mongod**: MongoDB ì‹œìŠ¤í…œì˜ ê¸°ë³¸ ë°ëª¬ í”„ë¡œì„¸ì„œ (ì„œë²„ì™€ ê°™ì€ ëŠë‚Œ)
**mongosh**: MongoDBì— ëŒ€í•œ ì‰˜ ì¸í„°íŽ˜ì´ìŠ¤ (í´ë¼ì´ì–¸íŠ¸ ê°™ì€ ëŠë‚Œ) = mongoDBì™€ ìƒí˜¸ìž‘ìš©ê°€ëŠ¥

mongodë¡œ ì„œë²„ë¥¼ í‚¤ê³  -> mongoë¡œ ì¸í„°íŽ˜ì´ìŠ¤ë¥¼ ì‹¤í–‰í•˜ì—¬ mongoDBì™€ ì†Œí†µgí•¨

ì¶œì²˜ : https://stackoverflow.com/questions/31981857/what-are-the-practical-differences-between-mongo-and-mongod

## 6.9 CRUD Introduction

ë°ì´í„°ë² ì´ìŠ¤ì—ê²Œ ë°ì´í„°ê°€ ì–´ë–»ê²Œ ìƒê²¼ëŠ”ì§€ ì•Œë ¤ì¤˜ì•¼í•¨ => íƒ€ìž…ì„ ì–¸ê³¼ ê°™ìŒ

## 6.10 Video Model

#### Schema

[Schemas](https://mongoosejs.com/docs/guide.html#schemas)
ëª½êµ¬ìŠ¤ì˜ ëª¨ë“  ê²ƒì€ ìŠ¤í‚¤ë§ˆë¡œ ì‹œìž‘
ê° ìŠ¤í‚¤ë§ˆëŠ” MongoDB ì»¬ë ‰ì…˜ì— ë§¤í•‘ë˜ê³  í•´ë‹¹ ì»¬ë ‰ì…˜ ë‚´ ë¬¸ì„œì˜ ëª¨ì–‘ì„ ì •ì˜í•¨

ëª¨ë¸ì˜ ìƒê¹€ìƒˆ(shape)ë¥¼ ì•Œë ¤ì¤Œ

```js
import mongoose from "mongoose";
const { Schema } = mongoose;

const blogSchema = new Schema({
  title: String, // String is shorthand for {type: String} ë™ì¼í•¨
  author: String,
  body: String,
  comments: [{ body: String, date: Date }],
  date: { type: Date, default: Date.now },
  hidden: Boolean,
  meta: {
    votes: Number,
    favs: Number,
  },
});
```

#### Mdoels

[Models](https://mongoosejs.com/docs/guide.html#models)
[Models](https://mongoosejs.com/docs/models.html)
dbë¥¼ mongooseì™€ ì—°ê²°ì‹œì¼œì„œ video modelì„ ì¸ì‹ì‹œí‚´
ìŠ¤í‚¤ë§ˆ ì •ì˜(Schema definition)ì„ ì‚¬ìš©í•˜ë ¤ë©´ ìž‘ì—…í• ìˆ˜ìžˆëŠ” modeal ë¡œ ë³€í™˜í•´ì•¼í•¨
`const Blog = mongoose.model('Blog',blogSchema);`
`mongoose.model(
  'ëª¨ë¸ì˜ ëŒ€ìƒì¸ ì»¬ë ‰ì…˜ì˜ ë‹¨ì¼ ì´ë¦„:ëª½êµ¬ìŠ¤ê°€ ìžë™ìœ¼ë¡œ ëª¨ë¸ì´ë¦„ì„ ë³µìˆ˜ ì†Œë¬¸ìž ë²„ì „ìœ¼ë¡œ ë³€í™˜',
  ìƒì„±í•œ ìŠ¤í‚¤ë§ˆ)`ë¥¼ í˜¸ì¶œí•˜ë©´ mongooseê°€ ëª¨ë¸ì„ ì»´íŒŒì¼í•¨

`mongoose.model(modelName, schema)`:
ëª¨ë¸ì€ ìŠ¤í‚¤ë§ˆ ì •ì˜ì—ì„œ ì»´íŒŒì¼ëœ ë©‹ì§„ ìƒì„±ìž
ëª¨ë¸ì˜ ì¸ìŠ¤í„´ìŠ¤ë¥¼ documentë¼ê³  í•¨
ëª¨ë¸ì€ ê¸°ë³¸ MongoDB ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë¬¸ì„œë¥¼ ë§Œë“¤ê³  ì½ìŒ

```js
import mongoose from "mongoose";

const videoSchema = new mongoose.Schema({
  title: String,
  description: String,
  createdAt: Date,
  hashtags: [{ type: String }],
  meta: {
    views: Number,
    rating: Number,
  },
});

const Video = mongoose.model("Video", videoSchema);
export default Video;
```

## 6.11 Our First Query

```js
// models/video.js
const Video = mongoose.model("Video", videoSchema);
export default Video;
```

Video modelì„ defaultë¡œ exportí•œ ë’¤,
import í•´ì„œ preloadë¥¼ ê°€ëŠ¥í•˜ê²Œ ë§Œë“¬.
modelì„ ë¯¸ë¦¬ complie ë˜ëŠ” create í•´ì•¼ì§€ ìš°ë¦¬ê°€ í•„ìš” í•  ë•Œ í•´ë‹¹ modelì„ ì‚¬ìš©í•  ìˆ˜ ìžˆìŒ

```js
//server.js
import "./db"; //connect to mongo
import "./models/video";

/*....*/
import "./models/Users";
import "./models/Comments";
```

ìœ„ì™€ ê°™ì´ ê³„ì† ë°˜ë³µë˜ê²Œ importë¥¼ í• ê²½ìš°, ì“¸ë°ì—†ëŠ” ì½”ë“œë§Œ ëŠ˜ì–´ë‚¨.
ë˜í•œ, importëŠ” serverì™€ ê´€ë ¨ì´ ì—†ìŒ

íŒŒì¼ì„ ë”°ë¡œ ë§Œë“¤ì–´ì„œ í•´ë‹¹ í˜•ì‹ì˜ import ë“¤ì„ ë¶„ë¦¬í•´ ë”°ë¡œ ê´€ë¦¬í•¨

1. server.js : ì„œë²„ êµ¬ì¶•. ì„œë²„ê°ì²´ë¥¼ ë§Œë“¬
   1. appê°ì²´ì— ì§ì ‘ get,post,put,deleteí•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ HTTPmethodë¡œ ë¼ìš°íŒ…í• ìˆ˜ìžˆìŒ
   2. ë¼ìš°íŒ… : ì›¹ í”„ë ˆìž„ì›Œí¬ëŠ” HTTìš”ì²­ì„ ë¶„ê¸°í•˜ëŠ” ë°©ë²•ì„ ì œê³µ. HTTPìš”ì²­ URLì— í•´ë‹¹í•˜ëŠ” **ì•Œë§žì€ ì‘ë‹µì˜ ê²½ë¡œë¥¼ ë¯¸ë¦¬ ì„¤ì •**

```js
import express from "express";
import morgan from "morgan";
import globalRouter from "./routers/globalRouter";
import videoRouter from "./routers/videoRouter";
import userRouter from "./routers/userRouter";

const app = express();
const logger = morgan();
app.set("view engine", "pug");
app.set("views", process.cwd() + "/src/views");
app.use(logger);
app.use(express.urlencoded({ extended: true })); /
app.use("/", globalRouter);
app.use("/users", userRouter);
app.use("/videos", videoRouter);

export default app;
```

2. init.js : ì›í•˜ëŠ” í¬íŠ¸ë¡œ ì—´ì–´ ì„œë²„ë¥¼ ì‹œìž‘í•¨(ì—°ê²°í•¨)
   1. app.lesten(ì„œë²„ë¥¼ ì˜¤í”ˆí•  í¬íŠ¸ ë²ˆí˜¸, ì„œë²„ì˜¤í”ˆì‹œ ì‹¤í–‰í•  ì½œë°±í•¨ìˆ˜) : ì›í•˜ëŠ” í¬íŠ¸ì— ì„œë²„ë¥¼ ì˜¤í”ˆ
   2. í¬íŠ¸ : ì™¸ë¶€ì™€ í†µì‹ í•  ìˆ˜ ìžˆëŠ” êµ¬ë©ìœ¼ë¡œ, ì›í•˜ëŠ” í¬íŠ¸ë¡œ ì½”ë“œìž‘ì„±ì‹œ ì™¸ë¶€ ì»´í“¨í„°ê°€ í•´ë‹¹ í¬íŠ¸ë¡œ(ì•„ì´í”¼ì£¼ì„œ:í¬íŠ¸ë²ˆí˜¸)ë¡œ ë“¤ì–´ì˜¬ ìˆ˜ ìžˆìŒ

```js
import "./db"; //connect to mongo
import "./models/video";
import app from "./server";

const PORT = 4000;

const handleListening = () =>
  console.log(`âœ… Server listenting on http://localhost:${PORT} ðŸš€`);

app.listen(PORT, handleListening);
```

3. í¬íŠ¸ë¥¼ ì—°ê²°í•´ì„œ ì„œë²„ë¥¼ ì—¬ëŠ” í•¨ìˆ˜ê°€ init.jsë¡œ ì´ë™í–ˆê¸°ë•Œë¬¸ì— package.json ì½”ë“œ ë³€ê²½

```json
  "scripts": {
    "dev": "nodemon --exec babel-node src/init.js"
  },
```

## 6.12 Our First Query part Two

nodeJSëŠ” ë¹„ë™ê¸°ë¡œ ìž‘ì—…ë˜ê¸° ë•Œë¬¸ì— ì½”ë“œìž‘ì„± ìˆœì„œê°€ ë¨¼ì €ì˜€ë”í•˜ë”ë¼ê³  ê²°ê³¼ëŠ” ìˆœì„œëŒ€ë¡œ ë‚˜ì˜¤ì§€ì•ŠìŒ

```js
import Video from "../models/Video";

export const home = (req, res) => {
  console.log("Start");
  Video.find({}, (error, videos) => {
    console.log("Finished");
    return res.render("home", { pageTitle: "Home", videos });
  });
  console.log("I finish first");
};
```

ê²°ê³¼ :

> âœ… Server listenting on http://localhost:4000 ðŸš€
> âœ… Connected to DB
> Start
> I finish first
> Finished
> GET / 304 102.987 ms - -

## 6.13 Async Await

1. callback í•¨ìˆ˜
   1. nodeJSê°€ ë¹„ë™ê¸°ì ìœ¼ë¡œ ìž‘ë™ë˜ê¸°ë•Œë¬¸ì—, ë™ê¸°í•¨ìˆ˜ì™€ í•¨ê»˜ ë¹„ë™ê¸°í•¨ìˆ˜ê°€ ì‹¤í–‰ë˜ë©´ ê²°ê³¼ ê°’ì„ ë°›ì•„ì˜¤ëŠ” ê²ƒì´ ìˆœì„œê°€ ë’¤ë°”ë€Œê²Œ ëœë‹¤
   2. í•¨ìˆ˜ì•ˆì˜ í•¨ìˆ˜ì´ê¸°ë•Œë¬¸ì— ì½œë°±ì§€ì˜¥ì´ ë‚˜ì˜¬ ì—¼ë ¤ê°€ ìžˆìŒ
   ```js
   console.log("start");
   Video.find({}, (error, videos) => {
     return res.render("home", { pageTitle: "Home", videos });
   });
   console.log("finished");
   ```
2. async await
   1. aysnc ìƒíƒœ(ë¹„ë™ê¸°)ì¼ë•Œë§Œ await í•¨ìˆ˜ë¥¼ ì•ˆì—ì„œ ì‚¬ìš©ê°€ëŠ¥ í•¨
   2. ì§ê´€ì ì´ë¼ëŠ” ìž¥ì . ì–´ë–¤ ë¶€ë¶„ì´ ì§„í–‰ë˜ëŠ”ì§€ ì—ëŸ¬ê°€ ë‚¬ëŠ”ì§€ í™•ì¸í•˜ê¸° ì‰¬ì›€
   3. await í•¨ìˆ˜ê°€ ì™„ë£Œë ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼(databaseì—ì„œ ê²°ê³¼ë¥¼ ë°›ì„ ë•Œ ê¹Œì§€ ë‹¤ë¥¸ìž‘ì—…ì„ ì‹œí–‰í•˜ì§€ ì•Šê²Œí•¨. ìˆœì„œëŒ€ë¡œ ì‹¤í–‰ ê°€ëŠ¥)
   4. try catch êµ¬ë¬¸ì„ ì‚¬ìš©í•˜ì—¬, try êµ¬ë¬¸ì•ˆì—ì„œ ì‹¤í–‰í•˜ëŠ” ê²ƒë“¤ì¤‘ ì—ëŸ¬ê°€ ë‚˜ë©´ cath(error)ë¡œ ë³´ë‚´ì ¸ ì—ëŸ¬ ì²˜ë¦¬ê°€ ë¨
   ```js
   export const home = async (req, res) => {
     const videos = await Video.find({});
     return res.render("home", { pageTitle: "Home", videos });
   };
   ```

## 6.14 Returns and Renders

1. return ì—­í• 
   - ë³¸ì§ˆì ì¸ return ì˜ ì—­í• (ê°’ì„ ë°˜í™˜)ë³´ë‹¤ í•¨ìˆ˜ë¥¼ ë§ˆë¬´ë¦¬ ì§“ëŠ” ì—­í• ë¡œ ì‚¬ìš©ë¨
   - res.redner() ì´í›„ í•¨ìˆ˜ë¥¼ ì‹¤í–‰ì‹œí‚¤ì§€ í•œê²Œ í•˜ê¸°ìœ„í•´. ë§Œì•½ ì´í›„ì—ë„ responseê°ì²´ì— ëŒ€í•œ í•¨ìˆ˜ë¥¼ ì‹¤í–‰ì‹œí‚¤ë©´ ì—ëŸ¬ê°€ë‚¨
2. renderí•œ ê²ƒì€ ë‹¤ì‹œ renderí•  ìˆ˜ ì—†ìŒ
   - res.render()/.redirect()/.sendState()/.end()ë“±

```js
export const home = (req, res) => {
  Video.find({}, (error, videos) => {
    return res.render("home", { pageTitle: "Home", videos });
  });
};
```

## 6.15 Creating a Video part One

input elementì—ì„œ nameì„ ì¶”ê°€í•´ì•¼ì§€ë§Œ, req.bodyì—ì„œ ê°’ì´ë“¤ì–´ì˜´

```pug
//uplaod.pug
block content
  form(method="POST")
    input(name="title", type="text", required, placeholder="Title")
    input(name="description", type="text", required, placeholder="description")
    input(name="createdAt", type="text", required, placeholder="createdAt")
    input(name="hashtags", type="text", required, placeholder="hashtags")
    input(type="submit", value="Upload Video")
```

**`String.prototype.trim()`** :

- ë¬¸ìžì—´ ì–‘ ëì˜ ê³µë°±ì„ ì œê±°í•˜ê³  ì›ë³¸ ë¬¸ìžì—´ì„ ìˆ˜ì •í•˜ì§€ì•Šê³  ìƒˆë¡œìš´ ë¬¸ìžì—´ì„ ë°˜í™˜í•¨
- ê³µë°± : space,tab, NBSP etc. / ê°œí–‰ë¬¸ìž : LF, CR etc.

```js
///videoController.js
export const postUpload = (req, res) => {
  const { title, description, createdAt, hashtags } = req.body;
  const video = new Video({
    title,
    description,
    createdAt: Date.now(),
    hashtags: hashtags
      .split(",")
      .map(word => (word.startsWith("#") ? word.trim() : `#${word.trim()}`)),
  });
  console.log(video);
  return res.redirect("/");
```

## 6.16 Creating a Video part Two

**MongoDBì˜ collectionì´ë¦„ì´ Videoê°€ ì•„ë‹Œ videosì¸ ì´ìœ **

MongooseëŠ” ìžë™ìœ¼ë¡œ ëª¨ë¸ì„ ì°¾ê³ , í•´ë‹¹ ëª¨ë¸ì˜ ì´ë¦„ì„ ë”°ì„œ ì†Œë¬¸ìž+ë’¤ì— s(ë³µìˆ˜í˜•)ì„ ë¶™ì—¬ ì»¬ë ‰ì…˜ì„ ìƒì„±í•¨
Tank ëª¨ë¸ì€ -> ì»¬ë ‰ì…˜ì— ì €ìž¥ë  ë•Œ, tanksë¡œ ì €ìž¥ë¨

ë°ì´í„°ë² ì´ìŠ¤ì— ì €ìž¥í•˜ê³  ë‚˜ì„œ redirect ë˜í•œ renderí•´ì•¼í•˜ê¸° ë•Œë¬¸ì— `async await`ì„ ì‚¬ìš©í•´ ë°ì´í„°ë² ì´ìŠ¤ ìž‘ì—…ì´ ëë‚˜ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ê²Œí•¨

1. `Document.prototype.save()`
2. `Model.create()`

#### Document.prototype.save()

[`Document.prototype.save()`](https://mongoosejs.com/docs/api.html#document_Document-save)

```js
export const postUpload = async (req, res) => {
  const { title, description, createdAt, hashtags } = req.body;
  const video = new Video({
    title,
    description,
    createdAt: Date.now(),
    hashtags: hashtags
      .split(",")
      .map(word => (word.startsWith("#") ? word.trim() : `#${word.trim()}`)),
  });
  await video.save();
  return res.redirect("/");
};
```

#### Model.create()

[`Model.create()`](https://mongoosejs.com/docs/api.html#model_Model.create)
í•˜ë‚˜ ì´ìƒì˜ ë¬¸ì„œë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ìž¥í•˜ê¸° ìœ„í•œ ì†ì‰¬ìš´ ë°©ë²•
`MyModel.create(docs)`ëŠ” ë¬¸ì„œì˜ ëª¨ë“  ë¬¸ì„œì— ëŒ€í•´ ìƒˆë¡œìš´ `MyModel(doc).save()`ë¥¼ ìˆ˜í–‰í•¨
`create()`ì„ í•˜ê²Œ ë˜ë©´ `save()`ë¥¼ ìƒëžµ ê°€ëŠ¥
`create()`ì´ ë‹¤ìŒ ë¯¸ë“¤ì›¨ì–´ì¸ `save()`ë¥¼ íŠ¸ë¦¬ê±°í•˜ê¸° ë•Œë¬¸

```js
export const postUpload = async (req, res) => {
  const { title, description, createdAt, hashtags } = req.body;
  await Video.create({
    title,
    description,
    createdAt: Date.now(),
    hashtags: hashtags
      .split(",")
      .map(word => (word.startsWith("#") ? word.trim() : `#${word.trim()}`)),
  });
  return res.redirect("/");
};
```

Collection: Documentë“¤ì„ ë‹´ê³  ìžˆëŠ” ë¬¶ìŒ

## 6.17 Exceptions and Validation

ìŠ¤í‚¤ë§ˆëŠ” ìžì„¸í•˜ê³  êµ¬ì²´ì ì¼ ìˆ˜ë¡ validationì— ì¢‹ìŒ

- Schemaì— ì„ ì–¸ëœ íƒ€ìž…ê³¼ ë‹¤ë¥¸ íƒ€ìž…ì„ ìž…ë ¥í•´ì„œ mongoDBì— ì €ìž¥í•˜ë ¤ê³ í•˜ë©´, ì €ìž¥ë˜ì§€ ì•Šê³  validation ì—ëŸ¬ê°€ ë°œìƒí•¨
- `required : true`ì¸ ê²½ìš°ì—, ëˆ„ë½ë˜ë©´ validation ì—ëŸ¬ ë°œìƒ
- `await`ì—ì„œ ì—ëŸ¬ê°€ ìƒê¸°ë©´, ì•„ë¬´ê²ƒë„ ì‹¤í–‰ë˜ì§€ì•Šê³  ë‚ ì•„ê°(ë‹¤ìŒ ì½”ë“œê³  ì‹¤í–‰ë˜ì§€ì•ŠìŒ)
  - ì´ê²ƒì„ ë³´ì™„í•˜ê¸°ìœ„í•´ `try catch`ìž‘ì„±

#### try catch

```js
// videoController.js
export const postUpload = async (req, res) => {
  const { title, description, createdAt, hashtags } = req.body;
  try {
    await Video.create({
      title,
      description,
      hashtags: hashtags
        .split(",")
        .map(word => (word.startsWith("#") ? word.trim() : `#${word.trim()}`)),
    });
    return res.redirect("/");
  } catch (error) {
    return res.render("upload", {
      pageTitle: "Upload Video",
      errorMessage: error._message, // ë°ì´í„°ë² ì´ìŠ¤ì— ì €ìž¥í•˜ì§€ ëª»í• ë•Œ ì˜¤ëŠ” ì—ëŸ¬ë©”ì‹œì§€ë¥¼ í´ë¼ì´ì–¸íŠ¸ë¡œ ì „ë‹¬í•¨
    });
  }
};
```

#### default : () / requried : true

Schema ì„ ì–¸ì‹œ, ê¸°ë³¸ ê°’ì„ ì„¤ì •í•  ìˆ˜ ìžˆìŒ

- `default:Date.now` í•¨ìˆ˜ë¥¼ ì‹¤í–‰ í•˜ì§€ì•Šê³  í•¨ìˆ˜ëª…ë§Œ ì“´ ì´ìœ  : ìŠ¤í‚¤ë§ˆë¥¼ ê¸°ë°˜ìœ¼ë¡œ ëª¨ë¸ì„ ì´ìš©í•´ì„œ ë°ì´í„°ë¥¼ Createí• ë•Œ í•´ë‹¹ í•¨ìˆ˜ë¥¼ ì‹¤í–‰ì‹œí‚´
- `required : true`: í•„ìˆ˜ë¡œ ìž…ë ¥í•´ì¤˜ì•¼í•˜ëŠ” ê°’

```js
import mongoose from "mongoose";

//modelì˜ data ìƒê¹€ìƒˆë¥¼ ì•Œë ¤ì£¼ëŠ” ìž‘ì—…
const videoSchema = new mongoose.Schema({
  title: { type: String, required: true },
  description: { type: String, required: true },
  createdAt: {
    type: Date,
    default: Date.now,
    /* videoë¥¼ ë§Œë“¤ì—ˆì„ëŒ€ í•´ë‹¹ Date.now() í•¨ìˆ˜ ì‹¤í–‰*/ required: true,
  },
  hashtags: [{ type: String }],
  meta: {
    views: { type: Number, default: 0, required: true },
    rating: { type: Number, default: 0, required: true },
  },
});

const Video = mongoose.model("Video", videoSchema);
export default Video;
```

`Model.create()` ë„ì¤‘, ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´ `errorMessage` ì¶œë ¥

```pug
block content
  if (errorMessage)
    span= errorMessage
  form(method="POST")
```

## 6.18 More Schema

[ëª½êµ¬ìŠ¤ ìŠ¤í‚¤ë§ˆ íƒ€ìž… í™•ì¸](https://mongoosejs.com/docs/schematypes.html)
Mongoose ìŠ¤í‚¤ë§ˆëŠ” Mongoose ëª¨ë¸ì„ êµ¬ì„±í•˜ê¸° ìœ„í•œ ê°ì²´ë¡œ ìƒê°í•  ìˆ˜ ìžˆìŒ

íƒ€ìž…ì´ êµ¬ì²´ì ì´ê³  ì •í™•í•  ìˆ˜ë¡, í”„ë¡œì íŠ¸êµ¬í˜„ì„ mongoose ì™€ mongoDBê°€ ë”ìš± íŽ¸í•˜ê²Œ ë§Œë“¤ì–´ì¤Œ

> **required**: boolean or function, if true adds a required validator for this property
> **default**: Any or function, sets a default value for the path. If the value is a function, the return value of the function is used as the default.
> **select**: boolean, specifies default projections for queries
> **validate**: function, adds a validator function for this property
> **get**: function, defines a custom getter for this property using Object.defineProperty().
> **set**: function, defines a custom setter for this property using Object.defineProperty().
> **alias**: string, mongoose >= 4.10.0 only. Defines a virtual with the given name that gets/sets this path.
> **immutable**: boolean, defines path as immutable. Mongoose prevents you from changing immutable paths unless the parent document has isNew: true.
> **transform**: function, Mongoose calls this function when you call Document#toJSON() function, including when you JSON.stringify() a document.

**String**

> **lowercase**: boolean, whether to always call .toLowerCase() on the value
> **uppercase**: boolean, whether to always call .toUpperCase() on the value
> **trim**: boolean, whether to always call .trim() on the value
> **match**: RegExp, creates a validator that checks if the value matches the given regular expression
> **enum**: Array, creates a validator that checks if the value is in the given array.
> **minLength**: Number, creates a validator that checks if the value length is not less than the given number
> **maxLength**: Number, creates a validator that checks if the value length is not greater than the given number
> **populate**: Object, sets default populate options

**Number**

> **min**: Number, creates a validator that checks if the value is greater than or equal to the given minimum.
> **max**: Number, creates a validator that checks if the value is less than or equal to the given maximum.
> **enum**: Array, creates a validator that checks if the value is strictly equal to one of the values in the given array.
> **populate**: Object, sets default populate options

**Date**

> **min**: Date, creates a validator that checks if the value is greater than or equal to the given minimum.
> **max**: Date, creates a validator that checks if the value is less than or equal to the given maximum.
> **expires**: Number or String, creates a TTL index with the value expressed in seconds.
> **ObjectId** > **populate**: Object, sets default populate options

[ëª½êµ¬ìŠ¤ ìŠ¤í‚¤ë§ˆ íƒ€ìž… ì •ì˜](https://mongoosejs.com/docs/guide.html)
ëª½êµ¬ìŠ¤ì˜ ëª¨ë“  ê²ƒì€ ìŠ¤í‚¤ë§ˆë¡œ ì‹œìž‘í•¨.
ê° ìŠ¤í‚¤ë§ˆëŠ” MongoDB ì»¬ë ‰ì…˜ì— ë§¤í•‘ë˜ê³  í•´ë‹¹ ì»¬ë ‰ì…˜ ë‚´ ë¬¸ì„œì˜ ëª¨ì–‘ì„ ì •ì˜í•¨

ìŠ¤í‚¤ë§ˆì˜ íƒ€ìž…ì •ì˜ì™€ input elementì—ë„ ì´ì¤‘ìœ¼ë¡œ í•˜ëŠ” ê²ƒì´ ì¢‹ìŒ

- input elementì—ë§Œ ì ìš©ì‹œ, ì¼ë¶€ ì‚¬ìš©ìžë“¤ì´ ì§ì ‘ htmlì„ ìˆ˜ì •í•˜ì—¬ ë°ì´í„°ë¥¼ ìž…ë ¥í•  ìˆ˜ ìžˆìŒ
- Schemaì—ë§Œ ì ìš©ì‹œ, validationì— ëŒ€í•œ ì—ëŸ¬ë©”ì‹œì§€ë¥¼ ì¶”ê°€í•´ì¤˜ì•¼í•¨

```js
// models/Video.js
const videoSchema = new mongoose.Schema({
  title: { type: String, required: true, maxLength: 80 },
  description: { type: String, required: true, minLength: 10 },
  createdAt: { type: Date, default: Date.now, required: true },

// upload.pug
  form(method="POST")
    input(
      placeholder="Title",
      required,
      type="text",
      name="title",
      maxLength=80)
    input(
      placeholder="Description",
      required,
      type="text",
      name="description",
      minLength=20)
```

## 6.19 Video Detail

**[ì •ê·œí‘œí˜„ì‹](http://regexpal.com)**

- [mdn ì •ê·œí‘œí˜„ì‹](https://developer.mozilla.org/ko/docs/Web/JavaScript/Guide/Regular_Expressions)

#### ëª½ê³ DB Document [ë§í¬1](https://mongodb.github.io/node-mongodb-native/api-bson-generated/objectid.html) [ë§í¬2](https://docs.mongodb.com/manual/reference/method/ObjectId/)

> class ObjectID()
> Arguments:
> id (string) â€“ Can be a 24 byte hex string, 12 byte binary string or a Number.
> ëª½ê³ DBëŠ” ObjectIDë¥¼ 24ë°”ì´íŠ¸ 16ì§„ ë¬¸ìžì—´ í‘œí˜„ìœ¼ë¡œ ë°˜í™˜í•œë‹¤.
> === ì •ê·œí‘œí˜„ì‹ :`([0-9a-f]{24})`

##### ì‹­ìœ¡ì§„ë²• (Hexadecimal)

ì‹­ìœ¡ì§„ë²•ì€ ì‹­ìœ¡ì„ ë°‘ìœ¼ë¡œ í•˜ëŠ” ê¸°ìˆ˜ë²•ì´ë‹¤. ë³´í†µ 0ë¶€í„° 9ê¹Œì§€ì˜ ìˆ˜ì™€ Aì—ì„œ Fê¹Œì§€ì˜ ë¡œë§ˆ ë¬¸ìžë¥¼ ì‚¬ìš©í•˜ê³ , ì´ë•Œ ëŒ€ì†Œë¬¸ìžëŠ” êµ¬ë³„í•˜ì§€ ì•ŠìŒ
**Hexadecimal**: 0~9ê¹Œì§€ì˜ ìˆ«ìžì™€ A-Fê¹Œì§€ì˜ ì•ŒíŒŒë²³ì´ ì¡°í•©ëœ string

#### [findOne()](https://mongoosejs.com/docs/api.html#model_Model.findOne)

í•´ë‹¹ ì¡°ê±´ê³¼ ì¼ì¹˜í•˜ëŠ” documentë¥¼ ì°¾ìŒ
\_idë¡œ ì°¾ëŠ” ê²½ìš°ì—ëŠ” `findById()`ë¥¼ ì‚¬ìš©í•  ê²ƒì„ ê¶Œìž¥
`findById(id)`ëŠ” ê±°ì˜ `findOne({ \_id: id })`ê³¼ ë™ì¼í•©ë‹ˆë‹¤.

#### [findById](https://mongoosejs.com/docs/api.html#model_Model.findById)

`async await` ìžŠì§€ë§ê¸° ã… ã… 

```js
export const watch = async (req, res) => {
  const { id } = req.params;
  const video = await Video.findById(id);
  return res.render("watch", { pageTitle: video.title, video });
};
```

#### [`option:id`](https://mongoosejs.com/docs/guide.html#id)

mongoose ì—ì„œ \_id ê°’ì„ idë¡œ ë°›ê²Œí•´ì¤Œ

```pug
extends base.pug
block content
  div
    p= video.title
    small= video.createdAt
  a(href=`${video.id}/edit`) Edit Video &rarr;
```

ì •ê·œí‘œí˜„ì‹ìœ¼ë¡œ idê°’ì„ ë§¤ì¹­ì‹œí‚´
`([0-9a-f]{24})` : 0~9, a~zë¡œ ì´ë£¨ì–´ì§„ 24ìž ë¬¸ìž

```js
videoRouter.get("/:id([0-9a-z]{24})", watch);
```

## 6.20 Edit Video part One

ì—ëŸ¬ì²˜ë¦¬ë¥¼ ë¨¼ì €í•¨

- `Video.findById(id)` ì˜ ê°’ì´ ì—†ëŠ”ê²½ìš° = ì‚¬ìš©ìžê°€ ì¡´ìž¬í•˜ì§€ì•ŠëŠ” id ê°’ì— ì ‘ê·¼í•˜ëŠ” ê²½ìš°
- ë°ì´í„°ê°€ ì—†ìœ¼ë©´ `404` íŽ˜ì´ì§€ë¡œ `rendering` í•´ì¤Œ

```js
// contoller/videoController.js
export const watch = async (req, res) => {
  const { id } = req.params;
  const video = await Video.findById(id); // ì¡´ìž¬í•˜ì§€ì•ŠëŠ” idê°’ì— ì ‘ê·¼ í•˜ëŠ” ê²½ìš°
  if (!video) {
    return res.render("404", { pageTitle: "Video not found." });
  }
  return res.render("watch", { pageTitle: video.title, video });
};
export const getEdit = async (req, res) => {
  const { id } = req.params;
  const video = await Video.findById(id);
  if (!video) {
    return res.render("404", { pageTitle: "Video not found." });
  }
  return res.render("edit", { pageTitle: `Editing ${video.title}`, video });
};
```

ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë°›ì•„ì˜¨ video ì •ë³´ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì±„ì›Œì¤Œ
í•´ì‰¬íƒœê·¸ì˜ ê²½ìš°ì—ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë°°ì—´ë¡œ ì €ìž¥í•˜ê¸° ë•Œë¬¸ì— `.join()`ë©”ì„œë“œë¥¼ ì‚¬ìš©í•´ string íƒ€ìž…ìœ¼ë¡œ ë³€í™˜í•¨

```pug
//edit.pug
form(method="POST")
  input(name="title", placeholder="Video Title", value=video.title, required)
  input(
    placeholder="Description",
    required,
    type="text",
    name="description",
    minlength=20,
    value=video.description) 
  input(
    placeholder="Hashtags, separated by comma.",
    required,
    type="text",
    name="hashtags",
    value=video.hashtags.join())
  input(value="Save", type="submit")
```

#### [`exec()`](https://mongoosejs.com/docs/promises.html)

promiseë¡œ ë°˜í™˜í•´ì£¼ëŠ” í•¨ìˆ˜.
í˜„ìž¬ `async await`í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ê³  ìžˆê¸°ë•Œë¬¸ì— `exec()`ì„ ì‚¬ìš©í•˜ë‚˜ í•˜ì§€ì•Šë‚˜ ê¸°ëŠ¥ ê²°ê³¼ëŠ” ë™ì¼í•¨

- find, findOne, findById, findOneAndUpdate ë“±ì˜ ë©”ì„œë“œì˜ ë¦¬í„´ê°’ì€ Query ìž„. Mongoose QueryëŠ” thenì„ ì‚¬ìš©í• ìˆ˜ìžˆëŠ” ìœ ì‚¬ promise
- ëŒ€ì‹  `exec()`ì„ ì‚¬ìš©í•˜ë©´ ì˜¨ì „í•œ promise ë°˜í™˜ê°’ì„ ì–»ì„ ìˆ˜ ìžˆìŒ.
- ì—ëŸ¬ê°€ ë‚¬ì„ë•Œ stack trace ì— ì˜¤ë¥˜ê°€ ë°œìƒˆí•œ ì½”ë“œì˜ ìœ„ì¹˜ê°€ í¬í•¨ë¨

## 6.21 Edit Video part Two

#### [`String.prototype.startsWith()`](https://developer.mozilla.org/ko/docs/Web/JavaScript/Reference/Global_Objects/String/startsWith)

startsWith() ë©”ì†Œë“œëŠ” ì–´ë–¤ ë¬¸ìžì—´ì´ íŠ¹ì • ë¬¸ìžë¡œ ì‹œìž‘í•˜ëŠ”ì§€ í™•ì¸í•˜ì—¬ ê²°ê³¼ë¥¼ true í˜¹ì€ falseë¡œ ë°˜í™˜

#### [`String.prototype.endsWith()`](https://developer.mozilla.org/ko/docs/Web/JavaScript/Reference/Global_Objects/String/endsWith)

The endsWith() ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ì–´ë–¤ ë¬¸ìžì—´ì—ì„œ íŠ¹ì • ë¬¸ìžì—´ë¡œ ëë‚˜ëŠ”ì§€ë¥¼ í™•ì¸í•  ìˆ˜ ìžˆìœ¼ë©°, ê·¸ ê²°ê³¼ë¥¼ true í˜¹ì€ falseë¡œ ë°˜í™˜

```js
// controller/videoController.js
export const postEdit = async (req, res) => {
  const { id } = req.params;
  const { title, description, hashtags } = req.body;
  const video = await Video.findById(id).exec();
  video.title = title;
  video.description = description;
  video.hashtags = hashtags
    .split(",")
    .map(word => (word.startsWith("#") ? word : `#${word}`));
  video.save();
  return res.redirect(`/videos/${id}`);
};
```

## 6.22 Edit Video part Three

#### [`Model.exists()`](https://mongoosejs.com/docs/api/model.html#model_Model-exists)

- Returns a document with \_id only if at least one document exists in the database that matches the given filter, and null otherwise.
- return : Query | null

```js
await Character.deleteMany({});
await Character.create({ name: "Jean-Luc Picard" });

await Character.exists({ name: /picard/i }); // { _id: ... }
await Character.exists({ name: /riker/i }); // null
```

#### [`Model.findByIdAndUpdate()`](https://mongoosejs.com/docs/api/model.html#model_Model-findByIdAndUpdate)

- Finds a matching document, updates it according to the update arg, passing any options, and returns the found document (if any).

```js
A.findByIdAndUpdate(id, update, options); // returns Query
A.findByIdAndUpdate(id, update); // returns Query
A.findByIdAndUpdate(); // returns Query
```

```js
// controller/videoController.js
export const postEdit = async (req, res) => {
  const { id } = req.params;
  const { title, description, hashtags } = req.body;
  const video = await Video.exists({ _id: id }).exec();
  if (!video) {
    return res.render("404", { pageTitle: "Video not found" });
  }
  await Video.findByIdAndUpdate(id, {
    title,
    description,
    hashtags: hashtags
      .split(",")
      .map(word => (word.startsWith("#") ? word : `#${word}`)),
  });
  return res.redirect(`/videos/${id}`);
};
```

## 6.23 Middlewares

### [Middleware](https://mongoosejs.com/docs/middleware.html#middleware)

ë¯¸ë“¤ì›¨ì–´(preë˜ëŠ” postí›…ì´ë¼ê³ ë„ ë¶ˆë¦¼)ëŠ” ë¹„ë™ê¸° í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ëŠ” ë™ì•ˆ ì œì–´ê°€ ì „ë‹¬ë˜ëŠ” í•¨ìˆ˜
ëª½êµ¬ìŠ¤ëŠ” `document middleware`, `model middleware`, `aggregate middleware`, `query middleware` 4ê°€ì§€ ë¯¸ë“¤ì›¨ì–´ ì¡´ìž¬

[model middlewareê°€ ì§€ì›í•˜ëŠ” ê¸°ëŠ¥](https://mongoosejs.com/docs/middleware.html#types-of-middleware)
document middlewareí•¨ìˆ˜ì—ì„œ thisëŠ” í˜„ìž¬ documentë¥¼ ì°¸ì¡°í•¨

ë°ì´í„°ë² ì´ìŠ¤ì— ì „ì²´ ë¹„ë””ì˜¤ ì‚­ì œ
db.videos.remove({})ê°€ deprecatedëë‹¤ê³  ëœ¨ì‹œëŠ” ë¶„ë“¤ì€
db.videos.deleteMany({})ë¡œ ì „ì²´ ë¹„ë””ì˜¤ë¥¼ ì‚­ì œí•˜ì‹œë©´ ë©ë‹ˆë‹¤.

[**Pre**](https://mongoosejs.com/docs/middleware.html#pre)
ì£¼ì˜! preì•ˆì— ì½œë°±í•¨ìˆ˜ë¡œ í™”ì‚´í‘œ í•¨ìˆ˜ ì“°ê²Œ ë˜ë©´ thisì˜ ëŒ€ìƒì´ ë‹¬ë¼ì§€ê¸° ë•Œë¬¸ì— function(){}ìœ¼ë¡œ ì¨ì•¼í•¨

```js
pre("save", async () => {});
X;
```

**`model` ì´ ë§Œë“¤ì–´ ì§€ê¸° ì „ì— ë¯¸ë“¤ì›¨ì–´ë¥¼ ë§Œë“¤ì–´ì•¼í•¨**

- `this` : ì €ìž¥í•˜ê³ ìž í•˜ëŠ” ë¬¸ì„œë¥¼ ê°€ë¦¬í‚´

```js
//models/Video.js
videoSchema.pre("save", async function () {
  this.hashtags = this.hashtags[0]
    .split(",")
    .map(word => (word.startsWith("#") ? word : `#${word}`));
});
```

### ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë°ì´í„° ì‚­ì œí•˜ê¸°

1. ëª½ê³  ì‚¬ìš©í•˜ê¸°
   $ mongosh
2. ë‚´ê°€ ê°€ì§„ db ë³´ê¸°
   $ show dbs
3. í˜„ìž¬ ì‚¬ìš© ì¤‘ì¸ db í™•ì¸
   $ db
4. ì‚¬ìš©í•  db ì„ íƒí•˜ê¸°
   $ use dbName
5. db ì»¬ë ‰ì…˜ ë³´ê¸°
   $ show collections
6. db ì»¬ë ‰ì…˜ ì•ˆì— documents ë³´ê¸°
   $ db.collectionName.find()
7. db ì»¬ë ‰ì…˜ ì•ˆì— documents ë‚´ìš© ëª¨ë‘ ì œê±°í•˜ê¸°
   $ db.collectionName.remove({})

## 6.24 Statics

### [Statics](https://mongoosejs.com/docs/guide.html#statics)

ëª¨ë¸ì— static í•¨ìˆ˜ë¥¼ ì¶”ê°€ ê°€ëŠ¥
ìŠ¤í‚¤ë§ˆì—ì„œ ì»´íŒŒì¼ëœ ëª¨ë¸ì— ì •ì  "class" ë©”ì„œë“œë¥¼ ì¶”ê°€í•¨

**Static ì‚¬ìš©í•˜ëŠ” ë‘ ê°€ì§€ ë°©ë²•**

```js
// Assign a function to the "statics" object of our animalSchema
animalSchema.statics.findByName = function (name) {
  return this.find({ name: new RegExp(name, "i") });
};
// Or, equivalently, you can call `animalSchema.static()`.
animalSchema.static("findByBreed", function (breed) {
  return this.find({ breed });
});
```

ë™ì¼í•œ ê¸°ëŠ¥ì„ í•˜ëŠ” `static í•¨ìˆ˜`

```js
// models/Video.js

//1
videoSchema.static("formatHashTags", function (hashtags) {
  return hashtags
    .split(",")
    .map(word => (word.startsWith("#") ? word : `#${word}`));
});

//2
videoSchema.statics.formatHashTags = function (hashtags) {
  return hashtags
    .split(",")
    .map(word => (word.startsWith("#") ? word : `#${word}`));
};
```

## 6.25 Delete Video

## 6.26 Search part One

## 6.27 Search part Two

## 6.28 Conclusions
