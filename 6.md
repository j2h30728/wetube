# 6 MONGODB AND MONGOOSE

## 6.0 Array Database part One

`req.params.id`

```js
export const see = (req, res) => {
  const { id } = req.params;
  const video = videos[id - 1];
  return res.render("watch", { pageTitle: `Watching ${video.title}` });
};
```

```pug
mixin video(info)
  div
    h4
      a(href=`videos/${info.id}`)= info.title
    ul
      li #{ info.rating }/5.
      li #{ info.comments } comments.
      li Posted #{ info.createdAt }.
      li #{ info.views } views.
```

## 6.1 Array Database part Two

#### absolute URL , relative URL

1. absolut URL :`/`부터 작성해서 절대경로 부터 시작
   `href='/videos/123/edit`
2. relative URL : 현재의 url 경로에서 이동
   `href='edit'`

## 6.2 Edit Video part One

#### POST , GET

```js
//videoControllers.js
export const watch = (req, res) => {
  const { id } = req.params;
  const video = videos[id - 1];
  return res.render("watch", { pageTitle: `Watching ${video.title}`, video });
};
export const edit = (req, res) => {
  const { id } = req.params;
  const video = videos[id - 1];
  return res.render("edit", { pageTitle: "Edit", video });
};
```

```pug
//watch.pug
extends base.pug

block content
  h3 #{ video.views } #{ video.views === 1 ? "view" : "views" }
  a(href=`${video.id}/edit`) Edit Video &rarr;
```

form 태그의 기본 기능은 GET 임

```pug
//edit.pug
extends base.pug

block content
  h4 Change Title of video

  form(action="testing-change", methdo="GET")
    input(name="title", placeholder="Video Title", value=video.title, required)
    input(value="Save", type="Submit")
```

위의 코드를 가진 form에서 값을 입력후 submit하게되면
아래의 링크로 이동하며 action프로퍼티 값으로 get요청을 보냄
(`form(action="testing-change" method="GET")` 와 동일함)
: form에 있는 정보가 url 로 들어감
`form(method="POST", action="/videos/otherurl")` : action 을 사용해 다른 url로 post 요청 가능

```
http://localhost:4000/videos/2/testing-change?title=testInputValue
Cannot GET /videos/2/testing-change

```

POST 요청으로 보내는 form

```pug
extends base.pug

block content
  h4 Change Title of video

  form(method="POST")
    input(name="title", placeholder="Video Title", value=video.title, required)
    input(value="Save", type="Submit")
```

```
http://localhost:4000/videos/2/edit
Cannot POST /videos/2/edit
```

edit post Router, Controller 추가

```js
//videoRouter.js
videoRouter.get("/:id(\\d+)/edit", getEdit);
videoRouter.post("/:id(\\d+)/edit", postEdit);

//videoController.js
export const getEdit = (req, res) => {
  const { id } = req.params;
  const video = videos[id - 1];
  return res.render("edit", { pageTitle: "Edit", video });
};
export const postEdit = (req, res) => {};
```

## 6.3 Edit Video part Two

#### [req.body](https://expressjs.com/ko/api.html#req.body)

`req.body`에는 `form`을 통해 `submit`된 데이터의 키-값 쌍을 포함함
기본적으로는 `undefined`이며 **`express.json()`** 또는 **`express.urlencoded()`**와 같은 바디 파싱 미들웨어를 사용할 때 값을 받아옴

```js
// 애플리케이션/json 파싱
app.use(express.json());
// application/x-www-form-urlencoded파싱 (form데이터 파싱)
// form 을 우리가 사용할 수있는 javascript object형식을 통역해줌
app.use(express.urlencoded({ extended: true }));
```

##### [`express.urlencoded([options])`](https://expressjs.com/ko/api.html#express.urlencoded)

Express에 내장된 미들웨어 기능
urlencoded 페이로드로 들어오는 요청을 구문 분석하고 바디 파서를 기반으로 함

##### route

get,post를 따로 쓰는 대신에, 하나의 경로만 필요로 하는 route사용
2개 이상의 method를 사용할 때 사용하는것이 용이

```js
//이전
videoRouter.get("/:id(\\d+)/edit", getEdit);
videoRouter.post("/:id(\\d+)/edit", postEdit);

//이후
videoRouter.route("/:id(\\d+)/edit").get(getEdit).post(postEdit);
```

POST 요청을 진행하고 watch 라우트로 리다이렉트
POST : back end로 데이터를 보냄

```js
export const postEdit = (req, res) => {
  const { id } = req.params; // 해당 id 값을 가져옴
  const title = req.body.title; // forn 에 입력한 값을 가져옴
  videos[id - 1].title = title; // form 에 입력한 값으로 title 수정
  return res.redirect(`/videos/${id}`); // 수정후, 해당 id의 watch route로 이동
};
```

## 6.4 Recap

input 에서 name 을 빠뜨리고 post 요청 보내면 req.body에서 데이터를 볼 수 없음

## 6.5 More Practice part One

## 6.6 More Practice part Two

```pug
extends base.pug

block content
  form(method="POST")
    input(name="title", type="text", required, placeholder="Title")
    input(type="submit", value="Upload Video")
```

**`postUpload` Controller**
두 경로로 이동

1. post request로 '/vidoes/upload/로 감
2. get request로 홈페이지인 '/' 감

```js
export const postUpload = (req, res) => {
  // here we will add a video to the videos array.
  return res.redirect("/");
};
```

## 6.7 Introduction to MongoDB

[MongoDB 다운로드 사이트](https://docs.mongodb.com/manual/installation)

[MongoDB 설치 (MacOS용)](https://docs.mongodb.com/manual/tutorial/install-mongodb-on-os-x/)
터미널에서 아래와 같이 입력하시면 됩니다.

1. xcode-select --install

2. brew tap mongodb/brew
   (Homebrew 설치가 안 되있으면 설치 필요)

3. brew install mongodb-community@5.0
   (버전은 추후에 달라질 수 있습니다.)

[MongoDB Compass (MongoDB GUI)](https://www.mongodb.com/products/compass)

## 6.8 Connecting to Mongo

node.js에서 mongoDB와 상호작용하기 위해 mongoose사용하는 것
(자바스트립트 코드를 mongoose가 mongoDB에게 전달해줌)

`mongosh
show dbs`

### mongoose 설치

`npm i mongoose`

`mongoose.connect("mongodb://127.0.0.1:27017/**만들고 싶은 데이터베이스 이름**")

mongo를 연결함

```js
import "./db";
```

데이터데이스(몽고)연결 세팅. 성공할 경우와 실패한 경우.

```js
//db.js
import mongoose from "mongoose";

mongoose.set("strictQuery", false);
mongoose.connect("mongodb://127.0.0.1:27017/wetube", {
  useNewUrlParser: true,
  useUnifiedTopology: true,
});

const db = mongoose.connection;
const handleOpen = () => console.log("✅ Connected to DB");
const handleError = error => console.log("❌ DB Error", error);

db.on("error", handleError); // error가 발생할 때 마다 실행됨
db.once("open", handleOpen); // 서버가 연결될 때 딱 한번 실행됨
```

---

macOS

`MongoDB shell version v5.0.0
connecting to: mongodb://127.0.0.1:27017/?compressors=disabled&gssapiServiceName=mongodb
Error: couldn't connect to server 127.0.0.1:27017, connection attempt failed: SocketException: Error connecting to 127.0.0.1:27017 :: caused by :: Connection refused :
connect@src/mongo/shell/mongo.js:372:17
@(connect):2:6
exception: connect failed
exiting with code 1
-----------------------------------`
이렇게 뜨면
M1: `mongod --config /opt/homebrew/etc/mongod.conf --fork`

**mongod**: MongoDB 시스템의 기본 데몬 프로세서 (서버와 같은 느낌)
**mongosh**: MongoDB에 대한 쉘 인터페이스 (클라이언트 같은 느낌) = mongoDB와 상호작용가능

mongod로 서버를 키고 -> mongo로 인터페이스를 실행하여 mongoDB와 소통g함

출처 : https://stackoverflow.com/questions/31981857/what-are-the-practical-differences-between-mongo-and-mongod

## 6.9 CRUD Introduction

## 6.10 Video Model

## 6.11 Our First Query

## 6.12 Our First Query part Two

## 6.13 Async Await

## 6.14 Returns and Renders

## 6.15 Creating a Video part One

## 6.16 Creating a Video part Two

## 6.17 Exceptions and Validation

## 6.18 More Schema

## 6.19 Video Detail

## 6.20 Edit Video part One

## 6.21 Edit Video part Two

## 6.22 Edit Video part Three

## 6.23 Middlewares

## 6.24 Statics

## 6.25 Delete Video

## 6.26 Search part One

## 6.27 Search part Two

## 6.28 Conclusions
